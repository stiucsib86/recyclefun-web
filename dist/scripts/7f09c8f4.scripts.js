"use strict";angular.module("recyclefunWebApp",["FacebookProvider"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/auth/login.html",controller:"LoginCtrl"}).when("/logout",{templateUrl:"views/auth/logout.html",controller:"LogoutCtrl"}).when("/register",{templateUrl:"views/auth/register.html",controller:"RegisterCtrl"}).when("/forget-password",{templateUrl:"views/auth/password-forget.html",controller:"PasswordForgetCtrl"}).when("/reset-password/:code",{templateUrl:"views/auth/password-reset.html",controller:"PasswordResetCtrl"}).when("/auth/reset-password/:passcode",{templateUrl:"views/auth/password-reset.html",controller:"PasswordResetCtrl"}).when("/notifications",{templateUrl:"views/user/notifications.html",controller:"UserNotificationsCtrl"}).when("/user/",{templateUrl:"views/user/view.html",controller:"UserProfileCtrl"}).when("/user/:userid",{templateUrl:"views/user/view.html",controller:"UserProfileCtrl"}).when("/user/:userid/profile",{templateUrl:"views/user/view.html",controller:"UserProfileCtrl"}).when("/user/:userid/edit",{templateUrl:"views/user/edit.html",controller:"UserEditCtrl"}).when("/user/:userid/settings",{templateUrl:"views/user/settings.html",controller:"UserSettingsCtrl"}).when("/user/:userid/detailed-transactions",{templateUrl:"views/user/detailed-transactions.html",controller:"UserProfileCtrl"}).when("/user/:userid/badges",{templateUrl:"views/user/badges.html",controller:"UserProfileCtrl"}).when("/manage",{templateUrl:"views/pwc-manage/overview.html",controller:"PwcOverviewCtrl"}).when("/manage/pwc",{templateUrl:"views/pwc-manage/overview.html",controller:"PwcOverviewCtrl"}).when("/manage/pwc/bin/:binId",{templateUrl:"views/pwc-manage/bin.html",controller:"PwcBinCtrl"}).when("/badge/:badgeId",{templateUrl:"views/badges/badge.html",controller:"BadgeCtrl"}).when("/leaderboard",{templateUrl:"views/home/leaderboard.html",controller:"LeaderboardCtrl"}).when("/bins-search",{templateUrl:"views/home/bins-search.html",controller:"BinsSearchCtrl"}).otherwise({redirectTo:"/"})}]);var pageUrlProtocol=jQuery.url().attr("protocol");window.location.href.indexOf("localhost")>0?angular.module("recyclefunWebApp").value("appConfig",{appName:"RecycleIT (Development)",url:{api:pageUrlProtocol+"://"+"recyclefun-api.ap01.aws.af.cm/"},facebook:{appId:"516418235114060",channelUrl:"/channel.html",status:!0,cookie:!0,xfbml:!0,permissions:"read_stream, publish_stream, email, read_friendlists"}}):angular.module("recyclefunWebApp").value("appConfig",{appName:"RecycleIT",url:{api:pageUrlProtocol+"://"+"recyclefun-api.ap01.aws.af.cm/"},facebook:{appId:"637970952903072",channelUrl:"/channel.html",status:!0,cookie:!0,xfbml:!0,permissions:"read_stream, publish_stream, email, read_friendlists"}}),angular.module("recyclefunWebApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=[1,2,3]}]),angular.module("recyclefunWebApp").controller("ApplicationCtrl",["$http","$location","$scope","$rootScope","$timeout","Facebook","appConfig",function(a,b,c,d,e,f,g){d._app=g,d._loading=d._loading||{},"undefined"!=typeof f&&f.init(d._app.facebook),c.FBLogin=function(){d._loading.FBLogin=!0,f.login()},d.$on("event.fb.auth.login",function(b,c){d._loading.FBLogin=!0;var e=c.authResponse;a({method:"GET",withCredentials:!0,url:d._app.url.api+"auth/",params:{accessToken:e.accessToken,type:"Facebook",fb_userID:e.userID}}).success(function(a){d.auth=a,d._loading.FBLogin=!1}).error(function(a){window.alert(a.message),d._loading.FBLogin=!1})}),d.GetAuth=function(){a({method:"GET",withCredentials:!0,url:d._app.url.api+"auth/",params:{}}).success(function(a){d.auth=a}).error(function(a){console.warn(a.message)})},c.$watch("auth",function(){if(d.auth&&d.auth.user){console.log("Welcome "+d.auth.user.name.display_name);var a=["/login","/register"];a.indexOf(b.path())>-1&&b.path("/user/"+d.auth.user.user_id)}}),c.Login=function(){var b=this;return b.loginForm.$valid&&a({method:"POST",withCredentials:!0,url:d._app.url.api+"auth/login",data:{identity:b.loginForm.inputEmail.$modelValue,password:b.loginForm.inputPassword.$modelValue,remember:b.loginForm.inputRemember.$modelValue}}).success(function(){d.GetAuth()}).error(function(a){b.loginForm._errorMessage=a.message}),!1},function(){d.GetAuth(),jQuery.backstretch(["images/bg/1.jpg","images/bg/2.jpg","images/bg/3.jpg","images/bg/4.jpg","images/bg/5.jpg"],{fade:1e3,duration:8e3})}()}]).controller("FacebookCtrl",function(){}),angular.module("recyclefunWebApp").controller("LoginCtrl",["$rootScope",function(a){a.GetAuth()}]).controller("RegisterCtrl",["$http","$rootScope","$scope",function(a,b,c){b.GetAuth(),c.Register=function(){var d=this;return jQuery("form[name=registerForm]").valid()?(a({method:"POST",withCredentials:!0,url:b._app.url.api+"auth/register",data:c.regFrm}).success(function(){b.GetAuth()}).error(function(a){console.warn(a),console.log(d,d),d.registerForm._errorMessage=a.message}),void 0):!1},c.InitializePage=function(){jQuery("form[name=registerForm]").validate({rules:{email:{required:!0,email:!0},password:{minlength:8,required:!0},confirmPassword:{equalTo:"[name=password]"}},highlight:function(a){jQuery(a).closest(".form-group").removeClass("has-success").addClass("has-error")},success:function(a){jQuery(a).html('<i class="icon-ok"></i>').addClass("valid").closest(".form-group").removeClass("has-error").addClass("has-success")}})},function(){c.InitializePage()}()}]).controller("LogoutCtrl",["$http","$location","$scope","$rootScope",function(a,b,c,d){c.Logout=function(){a({method:"GET",withCredentials:!0,url:d._app.url.api+"auth/logout"}).success(function(){d.auth={},b.path("/")}).error(function(a){console.warn(a)})},c.Logout()}]).controller("PasswordForgetCtrl",["$http","$location","$rootScope","$scope",function(a,b,c,d){d.PasswordForget=function(){a({method:"POST",withCredentials:!0,url:c._app.url.api+"auth/password_forget",data:{email:d.inputEmail}}).success(function(a){d.passwordForgetForm._completed=!0,d.passwordForgetForm._successMessage=a.message}).error(function(a){d.passwordForgetForm._errorMessage=a.message})}}]).controller("PasswordResetCtrl",["$http","$scope","$rootScope","$routeParams",function(a,b,c,d){b.frmInput={},b.passwordResetForm={},d.passcode&&(b.frmInput.passcode=d.passcode),b.PasswordResetCodeCheck=function(){a({method:"POST",withCredentials:!0,url:c._app.url.api+"auth/passcode_check",data:{passcode:b.frmInput.passcode}}).success(function(a){b.passwordResetCodeForm._completed=!0,b.passwordResetCodeForm._successMessage=a.message}).error(function(a){b.passwordResetCodeForm._errorMessage=a.message})},function(){d.passcode}()}]),angular.module("recyclefunWebApp").controller("BadgeCtrl",["$scope","$routeParams",function(a,b){a.badgeId=b.badgeId,a.badgeIdList=["1","2"],a.GetBadgeTemplateURL=function(a){return"views/badges/badge-"+a+".tpl.html"}}]),angular.module("recyclefunWebApp").controller("LeaderboardCtrl",["$scope",function(a){a.recyclingStatistics=[{id:1,player:"Jurong",wastetotal:"475,918",average_per_house:"0.5592",recycle_percentage:"5.48",paper:"330887",can:"9137",glass:"16653",plastic:"49460",cloth:"30347",misc:"39434",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"21",badge1:1,badge2:1,badge3:1},{id:2,player:"Clementi",wastetotal:"211,048",average_per_house:"0.3015",recycle_percentage:"2.35",paper:"117350",can:"13522",glass:"36548",plastic:"35094",cloth:"3401",misc:"5133",garden:"0",month:"1/1/2013",inc:0,dec:1,difference:"12",badge1:1,badge2:0,badge3:1},{id:3,player:"Bedok",wastetotal:"378,806",average_per_house:"0.5623",recycle_percentage:"4.16",paper:"165252",can:"9251",glass:"77517",plastic:"76018",cloth:"14347",misc:"36421",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"20",badge1:0,badge2:0,badge3:1},{id:4,player:"City",wastetotal:"98,223",average_per_house:"0.1087",recycle_percentage:"0.70",paper:"49501",can:"6818",glass:"18341",plastic:"17733",cloth:"2362",misc:"3468",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"20",badge1:0,badge2:0,badge3:1},{id:5,player:"HG-PG",wastetotal:"236,259",average_per_house:"0.3390",recycle_percentage:"1.11",paper:"142419",can:"13781",glass:"36216",plastic:"35521",cloth:"3952",misc:"4370",garden:"0",month:"1/1/2013",inc:1,dec:"FALSE",difference:"20",badge1:0,badge2:0,badge3:1},{id:6,player:"PRT",wastetotal:"339,657",average_per_house:"0.5639",recycle_percentage:"2.76",paper:"110111",can:"6143",glass:"114117",plastic:"95021",cloth:"14265",misc:"123",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"20",badge1:0,badge2:0,badge3:1},{id:7,player:"AMK",wastetotal:"176,144",average_per_house:"0.1978",recycle_percentage:"1.13",paper:"35282",can:"8756",glass:"36636",plastic:"32481",cloth:"18423",misc:"44566",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"20",badge1:0,badge2:0,badge3:1},{id:8,player:"TBM",wastetotal:"309,220",average_per_house:"0.3931",recycle_percentage:"1.98",paper:"88213",can:"8044",glass:"105949",plastic:"92355",cloth:"13148",misc:"1511",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"20",badge1:0,badge2:0,badge3:1},{id:9,player:"WL-Y",wastetotal:"285,822",average_per_house:"0.6055",recycle_percentage:"2.08",paper:"167031",can:"14142",glass:"45832",plastic:"45545",cloth:"6952",misc:"6320",garden:"0",month:"1/1/2013",inc:1,dec:0,difference:"20",badge1:0,badge2:0,badge3:1}],function(){function a(){var a=new google.visualization.Query("https://spreadsheets.google.com/tq?key=0Ap3K3Evv9lLsdGdtTGpWTXZtS1NMS2dPaURIV2tLekE&pub=1");a.setQuery('SELECT E,F,G,H,I,J,M,L WHERE B = "Clementi" ORDER BY M'),a.send(b)}function b(a){if(a.isError())return alert("Error in query: "+a.getMessage()+" "+a.getDetailedMessage()),void 0;var b=a.getDataTable(),d=new google.visualization.DataView(b);d.setColumns([6,7]),c=new google.visualization.BarChart(document.getElementById("visualization-chart-id"));var e={title:"Clementi Recycle over times (kg)",width:535,height:500};c.draw(d,e);var f=new google.visualization.PieChart(document.getElementById("pie-chart-id")),g=new google.visualization.DataTable;g.addColumn("string","Category"),g.addColumn("number","Kg"),g.addRows([["Paper",117350],["Can",13522],["Glass",36548],["Plastic",35094],["Cloth",3401],["Miscellaneous",5133]]);var h={title:"Clementi Recycle Category",width:535,height:300,is3D:!0};f.draw(g,h)}var c;google.load("visualization","1",{callback:'console.log("Workaround for blank page. Read http://stackoverflow.com/questions/9519673/why-does-google-load-cause-my-page-to-go-blank ")',packages:["piechart","corechart","geomap"]}),google.setOnLoadCallback(a)}()}]).controller("BinsSearchCtrl",["$http","$scope","$timeout",function(a,b,c){b.GetBinsStatistics=function(){jQuery("#bar-example").length>0&&Morris.Bar({element:"bar-example",data:[{y:"Ang Mo Kio",a:100,b:197},{y:"Bedok",a:75,b:562},{y:"City",a:50,b:108},{y:"Clementi",a:75,b:301},{y:"Hougang",a:50,b:339},{y:"Jurong",a:68,b:559},{y:"Tampines",a:75,b:563},{y:"Queenstown",a:100,b:393},{y:"Woodlands",a:200,b:605}],xkey:"y",ykeys:["a","b"],labels:["Number of bins","Collection per household"]})},b.InitializeOneMap=function(){var a="28968.103,33560.969",d=2;b.OneMap=new GetOneMap("divMain","SM",{level:d,center:a}),c(function(){var a="assets/data/binsMapLocation.kml";b.OneMap.overlayKML(a)},1e3)},b.GetBinsLocation=function(){a({method:"GET",url:"assets/data/binsLocation.json"}).success(function(a){b.recyclingBinLocations=a})},function(){b.InitializeOneMap(),b.GetBinsStatistics(),b.GetBinsLocation()}()}]),angular.module("recyclefunWebApp").controller("PwcOverviewCtrl",["$http","$scope","$rootScope","$routeParams",function(a,b,c,d){b._loading={},b._error={},b.userid=d.userid,b.IsPageOwner=function(){return c.auth&&!d.userid?!0:void 0},b.binsStatus=[{id:"1",address:"102, Jurong East Street 13",status:"55"},{id:"2",address:"105, Jurong East Street 13",status:"97"},{id:"3",address:"112, Jurong East Street 13",status:"71"},{id:"4",address:"203, Jurong East Street 21",status:"63"},{id:"5",address:"207, Jurong East Street 21",status:"35"},{id:"6",address:"210, Jurong East Street 21",status:"61"},{id:"7",address:"219A, Jurong East Street 21",status:"20"},{id:"8",address:"223A, Jurong East Street 21",status:"22"},{id:"9",address:"228, Jurong East Avenue 1",status:"43"},{id:"10",address:"230, Jurong East Street 21",status:"92"}]}]).controller("PwcBinCtrl",["$http","$scope","$rootScope","$routeParams",function(a,b,c,d){b._loading={},b._error={},b.userid=d.userid,b.IsPageOwner=function(){return c.auth&&!d.userid?!0:void 0},jQuery("#line-fill-level").length>0&&Morris.Line({element:"line-fill-level",data:[{y:"2013-09-23",a:23},{y:"2013-09-23",a:24},{y:"2013-09-24",a:30},{y:"2013-09-25",a:48},{y:"2013-09-26",a:68},{y:"2013-09-27",a:90},{y:"2013-09-28",a:92}],xkey:"y",ykeys:["a"],labels:["Fill level"]})}]),angular.module("recyclefunWebApp").controller("UserProfileCtrl",["$http","$scope","$rootScope","$routeParams",function(a,b,c,d){b._loading={},b._error={},b.userid=d.userid,b.IsPageOwner=function(){return c.auth&&!d.userid?!0:void 0},b.GetUser=function(){b._loading.GetUser=!0,a({method:"GET",withCredentials:!0,url:c._app.url.api+"user",params:{user_id:d.userid}}).success(function(a){b._loading.GetUser=!1,b._error.message=!1,b.user=a.data,b.GetUserTransactions()}).error(function(a){b._loading.GetUser=!1,b._error.message=a.error,console.warn(a.error)})},b.GetUserTransactions=function(){b._loading.GetUserTransactions=!0,a({method:"GET",withCredentials:!0,url:c._app.url.api+"user/transactions",params:{user_id:d.userid}}).success(function(a){b._loading.GetUserTransactions=!1,b._error.message=!1,b.user.transactions=a.data,b.RenderTransactionBar()}).error(function(a){b._loading.GetUserTransactions=!1,b._error.message=a.error,b.user.transactions=[],console.warn(a.error)})},b.GetUser(),b.RenderTransactionBar=function(){if(b.user&&b.user.transactions){var a=b.user.transactions.reduce(function(a,b){var c={y:b.transactiondate,a:b.recyclable_amount};return a.push(c),a},[]);Morris.Bar({element:"bar-transaction",data:a.reverse(),barColors:["green"],xkey:"y",ykeys:["a"],labels:["kg"]})}},jQuery("#donut-example").length>0&&(Morris.Donut({element:"donut-example",data:[{label:"Paper",value:6},{label:"Can",value:3},{label:"Glass",value:7},{label:"Plastic",value:4},{label:"Cloth",value:4},{label:"Garden",value:2},{label:"misc",value:1}]}),b.RenderTransactionBar(),Morris.Bar({element:"bar-example",data:[{y:"April",a:5,b:40},{y:"May",a:4,b:65},{y:"Jun",a:6,b:40},{y:"July",a:7,b:65},{y:"Aug",a:9,b:90}],xkey:"y",ykeys:["a"],labels:["Series A"]}))}]).controller("UserSettingsCtrl",["$http","$scope","$rootScope",function(a,b,c){b.user={},b._loading={GetUserSettings:!0,SaveUserSettings:!1},b.GetUserSettings=function(){b._loading.GetUserSettings=!0,a({method:"GET",withCredentials:!0,url:c._app.url.api+"user"}).success(function(a){b._loading.GetUserSettings=!1,b.user=a.data}).error(function(a){console.warn(a)})},b.SaveUserSettings=function(){b._loading.SaveUserSettings=!0,a({method:"POST",withCredentials:!0,url:c._app.url.api+"user",data:b.user}).success(function(){b._loading.SaveUserSettings=!1,alert("Settings saved.")}).error(function(a){console.warn(a)})},function(){b.GetUserSettings()}()}]).controller("UserBadgesCtrl",function(){}).controller("UserNotificationsCtrl",function(){}),angular.module("recyclefunWebApp").directive("fbElm",function(){return{restrict:"A",link:function(){"undefined"!=typeof FB&&FB.XFBML.parse()}}});var app_provider=angular.module("FacebookProvider",[]);app_provider.factory("Facebook",["$rootScope",function(a){var b={};return b.permissions="read_stream, publish_stream, email",b.channelUrl="/channel.html",b.status=!0,b.cookie=!0,b.xfbml=!0,{init:function(a){angular.extend(b,a),window.fbAsyncInit=function(){FB.init({appId:b.appId,channelUrl:b.channelUrl,status:b.status,cookie:b.cookie,xfbml:b.xfbml})},function(a){var b,c="facebook-jssdk",d=a.getElementsByTagName("script")[0];a.getElementById(c)||(b=a.createElement("script"),b.id=c,b.async=!0,b.src="//connect.facebook.net/en_US/all.js",d.parentNode.insertBefore(b,d))}(document)},getLoginStatus:function(){FB.getLoginStatus(function(b){a.$broadcast("event.fb.auth.statusChange",{status:b.status})},!0)},login:function(){FB.getLoginStatus(function(c){switch(c.status){case"connected":a.$broadcast("event.fb.auth.login",{authResponse:c.authResponse});break;case"not_authorized":FB.login(function(b){b.authResponse?a.$broadcast("event.fb.auth.login",{facebook_id:b.authResponse.userID,userNotAuthorized:!0}):a.$broadcast("event.fb.auth.login.failed")},{scope:b.permissions});break;default:FB.login(function(b){b.authResponse?(a.$broadcast("event.fb.auth.login",{facebook_id:b.authResponse.userID}),a.$broadcast("event.fb.auth.authResponseChange")):a.$broadcast("event.fb.auth.login.failed")})}},!0)},logout:function(){FB.logout(function(b){b?a.$broadcast("event.fb.auth.logout"):a.$broadcast("event.fb.auth.logout.failed")})},unsubscribe:function(){FB.api("/me/permissions","DELETE",function(){a.$broadcast("event.fb.auth.authResponseChange")})}}}]);